#!/bin/bash

GKEYRING=$HOME/scripts/gkeyring.py
PURPLE_FOLDER=$HOME/.purple
TEMP_FOLDER=$(mktemp -d)


function cleanup()
{
    sed -i'' -e'/<password>/d' $TEMP_FOLDER/accounts.xml
    for i in $(find $TEMP_FOLDER/ -maxdepth 1 -mindepth 1 -type f);
    do
        cp $i $PURPLE_FOLDER/$(basename $i);
    done;
    rm -rf $TEMP_FOLDER
}

for i in $(find $PURPLE_FOLDER/ -maxdepth 1 -mindepth 1);
do
    ln -s $i $TEMP_FOLDER/$(basename $i);
done;

rm $TEMP_FOLDER/accounts.xml && cp $PURPLE_FOLDER/accounts.xml $TEMP_FOLDER/accounts.xml

accounts="acct@gmail.com acct2@hotmail.com acct3@yahoo.com 999999999"
#pwds=$(gpg2 --use-agent --decrypt $HOME/passwords/passwords.gpg)

for acc in $accounts;
do
    #pwd=$(echo "$pwds" | grep -oP "(?<=$acc ).*")
    pwd=$($GKEYRING -p account=$acc --output=secret)
    sed -i'' -e"s#<name>$acc/*</name>#&\n\t\t<password>$pwd</password>#" $TEMP_FOLDER/accounts.xml
done;

trap cleanup EXIT

pidgin --config=$TEMP_FOLDER

